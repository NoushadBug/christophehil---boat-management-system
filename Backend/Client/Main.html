<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boat Management System</title>
    <meta name="author" content="noushadBug">
    <meta name="description" content="Professional boat management system for tour operators">

    <!-- Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&family=Veneer&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <?!= include('Backend/Client/Styles/Stylesheet'); ?>

</head>

<body x-data="dashboardApp()" 
    x-init="() => { 
        initializeDashboard();
        setTimeout(() => loading = false, 800);
        checkSession();
    }"
    class="font-family-karla flex">

    <script>
        function initializeDashboard() {
            // Initialize Alpine store
            if (window.Alpine) {
                window.Alpine.store('appStore', {
                    isULoggedIn: false,
                    user: null,
                    dashboardView: true,
                    bookingsView: false,
                    messagesView: false,
                    adminView: false
                });
            }
        }
    </script>

    <!-- Full-Screen Loading Animation -->
    <div x-show="loading" class="fixed inset-0 flex items-center justify-center bg-gray-800 z-50">
        <div class="flex items-center justify-center">
            <div class="w-16 h-16 border-t-4 border-b-4 border-white rounded-full animate-spin"></div>
        </div>
    </div>

    <!-- login starts -->
    <?!= include('Backend/Client/Login'); ?>
    <!-- login ends -->

    <aside x-transition x-show="$store.appStore.isULoggedIn"
        class="relative bg-sidebar h-screen w-64 sm:block hidden shadow-xl">
        <div class="p-6">
            <a href="#0" class="text-white text-3xl font-semibold uppercase hover:text-gray-300">
                <img src="https://cdn-icons-png.flaticon.com/512/6733/6733991.png" class="w-12 h-12"
                    style="filter: drop-shadow(2px 4px 6px black);">
            </a>
            <button @click="openAddBookingModal()"
                class="w-full bg-white cta-btn font-semibold py-2 mt-5 rounded-lg rounded-lg rounded-lg shadow-lg hover:shadow-xl hover:text-white hover:bg-blue-800 flex items-center justify-center">
                <i class='bx bx-plus mr-3'></i> New Booking
            </button>
        </div>
        <nav class="text-white text-base font-semibold pt-3">
            <a class="flex items-center text-white py-4 pl-6 nav-item cursor-pointer opacity-75 hover:opacity-100"
                :class="$store.appStore.dashboardView? 'active-nav-link opacity-100':''"
                @click="changeView('dashboardView'); loadData();">
                <i class='bx bx-home-alt mr-3'></i>
                Dashboard
            </a>
            <a class="flex items-center text-white py-4 pl-6 nav-item cursor-pointer opacity-75 hover:opacity-100"
                :class="$store.appStore.bookingsView? 'active-nav-link opacity-100':''"
                @click="changeView('bookingsView'); loadData();">
                <i class='bx bx-calendar mr-3'></i>
                Bookings
            </a>
            <a class="flex items-center text-white py-4 pl-6 nav-item cursor-pointer opacity-75 hover:opacity-100"
                :class="$store.appStore.messagesView? 'active-nav-link opacity-100':''"
                @click="changeView('messagesView');">
                <i class='bx bx-message-square-dots mr-3'></i>
                Messages
            </a>
            <a x-show="isAdmin()"
                class="flex items-center text-white py-4 pl-6 nav-item cursor-pointer opacity-75 hover:opacity-100"
                :class="$store.appStore.adminView? 'active-nav-link opacity-100':''"
                @click="changeView('adminView'); loadData();">
                <i class='bx bx-cog mr-3'></i>
                Admin
            </a>
        </nav>
        <a @click="logout()"
            class="cursor-pointer absolute w-full upgrade-btn bottom-0 active-nav-link text-white flex items-center justify-center py-4">
            <i class='bx bx-log-out mr-3'></i>
            Sign out
        </a>
    </aside>

    <div x-transition x-show="$store.appStore.isULoggedIn"
        class="relative w-full flex flex-col h-screen overflow-y-hidden">
        <!-- Desktop Header -->
        <header class="w-full items-center bg-white py-2 px-6 hidden sm:flex">
            <div class="w-1/2">
                <h1 class="text-2xl font-bold text-gray-800">Boat Management System</h1>
            </div>
            <div x-data="{ isOpen: false }" class="relative w-1/2 flex justify-end">
                <span class="content-center px-1">Logged in as </span>
                <button @click="isOpen = !isOpen"
                    class="justify-center h-10 w-auto px-2 text-left bg-zinc-600 rounded-full text-white relative z-10 flex items-center text-sm overflow-hidden">
                    <span class="userName whitespace-nowrap overflow-hidden">Admin</span>
                </button>
                <button x-show="isOpen" @click="isOpen = false"
                    class="bg-transparent h-full w-full fixed inset-0 cursor-default"></button>
                <div x-show="isOpen"
                    class="cursor-pointer z-10 absolute w-32 bg-white border-2 border-slate-950 rounded-lg shadow-xl py-2 mt-16">
                    <a @click="isOpen = !isOpen; logout()" class="block px-4 py-2 account-link hover:text-white">Sign
                        Out</a>
                </div>
            </div>
        </header>

        <!-- Mobile Header & Nav -->
        <header x-data="{ isOpen: false }" class="mobile-header w-full bg-sidebar py-5 px-6 sm:hidden">
            <div class="flex items-center justify-between">
                <a href="#0" class="text-white text-3xl font-semibold uppercase hover:text-gray-300">
                    <img src="https://cdn-icons-png.flaticon.com/512/6733/6733991.png" class="w-10 h-10"
                        style="filter: drop-shadow(2px 4px 6px black);">
                </a>
                <button @click="isOpen = !isOpen" class="bg-transparent text-white text-3xl focus:outline-none">
                    <i x-show="!isOpen" class='bx bx-menu'></i>
                    <i x-show="isOpen" class='bx bx-x'></i>
                </button>
            </div>

            <!-- Dropdown Nav -->
            <nav :class="isOpen ? 'flex': 'hidden'" class="flex flex-col pt-4">
                <a class="flex items-center text-white py-4 pl-6 nav-item"
                    :class="$store.appStore.dashboardView? 'active-nav-link':''"
                    @click="changeView('dashboardView'); loadData();">
                    <i class='bx bx-home-alt mr-3'></i>
                    Dashboard
                </a>
                <a class="flex items-center text-white py-4 pl-6 nav-item"
                    :class="$store.appStore.bookingsView? 'active-nav-link':''"
                    @click="changeView('bookingsView'); loadData();">
                    <i class='bx bx-calendar mr-3'></i>
                    Bookings
                </a>
                <a class="flex items-center text-white py-4 pl-6 nav-item"
                    :class="$store.appStore.messagesView? 'active-nav-link':''" @click="changeView('messagesView');">
                    <i class='bx bx-message-square-dots mr-3'></i>
                    Messages
                </a>
                <a class="flex items-center text-white py-4 pl-6 nav-item"
                    :class="$store.appStore.adminView? 'active-nav-link':''"
                    @click="changeView('adminView'); loadData();">
                    <i class='bx bx-cog mr-3'></i>
                    Admin
                </a>
                <button @click="logout()"
                    class="w-full bg-white cta-btn font-semibold py-2 mt-3 rounded-lg shadow-lg hover:shadow-xl hover:bg-gray-300 flex items-center justify-center">
                    <i class='bx bx-log-out mr-3'></i> Sign Out
                </button>
            </nav>
        </header>

        <div class="w-full h-screen overflow-x-hidden border-t flex flex-col">
            <main class="main-center w-full flex-grow px-6 py-2">

                <!-- Dashboard View -->
                <div x-show="$store.appStore.dashboardView" class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card p-4">
                            <h3 class="text-sm font-medium text-gray-500">Total Bookings</h3>
                            <p class="text-2xl font-bold text-gray-900" x-text="bookings.length"></p>
                        </div>
                        <div class="card p-4">
                            <h3 class="text-sm font-medium text-gray-500">Today's Bookings</h3>
                            <p class="text-2xl font-bold text-blue-600" x-text="getTodayBookings().length"></p>
                        </div>
                        <div class="card p-4">
                            <h3 class="text-sm font-medium text-gray-500">Total PAX</h3>
                            <p class="text-2xl font-bold text-green-600" x-text="getTotalPax()"></p>
                        </div>
                        <div class="card p-4">
                            <h3 class="text-sm font-medium text-gray-500">Active Boats</h3>
                            <p class="text-2xl font-bold text-purple-600" x-text="boats.length"></p>
                        </div>
                    </div>

                    <!-- Bookings Table -->
                    <div class="bg-white rounded shadow overflow-hidden">
                        <div class="px-6 py-4 border-b">
                            <h2 class="text-lg font-semibold text-gray-800">Recent Bookings</h2>
                        </div>
                        <div class="p-6">
                            <table id="bookingsTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Trip Type</th>
                                        <th>Boat</th>
                                        <th>Clients</th>
                                        <th>PAX</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="booking in sortedBookings.filter(b => canViewBoat(b.Boat))"
                                        :key="booking.BookingID">
                                        <tr>
                                            <td x-text="formatDate(booking.Date)"></td>
                                            <td>
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                    :class="getTripBadgeClass(booking.TripType)"
                                                    x-text="booking.TripType"></span>
                                            </td>
                                            <td x-text="booking.Boat"></td>
                                            <td x-text="booking.Clients"></td>
                                            <td x-text="booking.TotalPAX"></td>
                                            <td>
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                    :class="getStatusBadgeClass(booking.Status)"
                                                    x-text="booking.Status"></span>
                                            </td>
                                            <td>
                                                <button
                                                    @click="canEditBooking(booking) ? editBooking(booking) : showToast('No permission', 'error')"
                                                    :disabled="!canEditBooking(booking)"
                                                    class="text-blue-600 hover:text-blue-900 mr-2"
                                                    :class="!canEditBooking(booking) ? 'opacity-50 cursor-not-allowed' : ''">
                                                    <i class='bx bx-edit-alt'></i>
                                                </button>
                                                <button
                                                    @click="canEditBooking(booking) ? deleteBooking(booking.BookingID) : showToast('No permission', 'error')"
                                                    :disabled="!canEditBooking(booking)"
                                                    class="text-red-600 hover:text-red-900"
                                                    :class="!canEditBooking(booking) ? 'opacity-50 cursor-not-allowed' : ''">
                                                    <i class='bx bx-trash'></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bookings View -->
                <div x-show="$store.appStore.bookingsView" class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">All Bookings</h1>
                        <button @click="openAddBookingModal()"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center">
                            <i class='bx bx-plus mr-2'></i> Add Booking
                        </button>
                    </div>

                    <div class="bg-white rounded shadow overflow-hidden">
                        <div class="p-6">
                            <table id="allBookingsTable" class="w-full">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Date</th>
                                        <th>Trip Type</th>
                                        <th>Boat</th>
                                        <th>Clients</th>
                                        <th>PAX</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="booking in sortedBookings" :key="booking.BookingID">
                                        <tr>
                                            <td x-text="booking.BookingID"></td>
                                            <td x-text="formatDate(booking.Date)"></td>
                                            <td>
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                    :class="getTripBadgeClass(booking.TripType)"
                                                    x-text="booking.TripType"></span>
                                            </td>
                                            <td x-text="booking.Boat"></td>
                                            <td x-text="booking.Clients"></td>
                                            <td x-text="booking.TotalPAX"></td>
                                            <td x-text="booking.Payment"></td>
                                            <td>
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                    :class="getStatusBadgeClass(booking.Status)"
                                                    x-text="booking.Status"></span>
                                            </td>
                                            <td>
                                                <button @click="editBooking(booking)"
                                                    class="text-blue-600 hover:text-blue-900 mr-2">
                                                    <i class='bx bx-edit-alt'></i>
                                                </button>
                                                <button @click="deleteBooking(booking.BookingID)"
                                                    class="text-red-600 hover:text-red-900">
                                                    <i class='bx bx-trash'></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Messages View -->
                <div x-show="$store.appStore.messagesView" class="space-y-6">
                    <h1 class="text-2xl font-bold text-gray-800">Daily Messages</h1>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label class="block mb-1 font-semibold">Select Date</label>
                                <input type="date" x-model="messageDate" class="w-full border px-3 py-2 rounded">
                            </div>
                            <div class="flex-1">
                                <label class="block mb-1 font-semibold">Type</label>
                                <select x-model="messageType" class="w-full border px-3 py-2 rounded">
                                    <option value="driver">Driver</option>
                                    <option value="staff">Welcome Staff</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <button @click="generateMessage"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center">
                                <i class='bx bx-message-square-dots mr-2'></i> Generate Message
                            </button>
                        </div>
                        <div x-show="generatedMessage" class="bg-gray-50 border rounded p-4 mb-2">
                            <pre class="whitespace-pre-wrap text-sm" x-text="generatedMessage"></pre>
                            <div class="flex gap-2 mt-2">
                                <button @click="copyMessage"
                                    class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 flex items-center">
                                    <i class='bx bx-copy mr-1'></i> Copy
                                </button>
                                <button @click="printMessage"
                                    class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 flex items-center">
                                    <i class='bx bx-printer mr-1'></i> Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin View -->
                <div x-show="isAdmin() && $store.appStore.adminView" class="space-y-6">
                    <h1 class="text-2xl font-bold text-gray-800">Admin Panel</h1>

                    <div class="card p-6">
                        <div class="mb-6">
                            <h3 class="font-semibold mb-2">Users</h3>
                            <table id="usersTable" class="min-w-full bg-gray-50 rounded mb-4">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2">Name</th>
                                        <th class="px-4 py-2">Email</th>
                                        <th class="px-4 py-2">Role</th>
                                        <th class="px-4 py-2">Access Boats</th>
                                        <th class="px-4 py-2">Permissions</th>
                                        <th class="px-4 py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="user in users" :key="user.ID">
                                        <tr>
                                            <td class="border px-4 py-2" x-text="user.Name"></td>
                                            <td class="border px-4 py-2" x-text="user.Email"></td>
                                            <td class="border px-4 py-2" x-text="user.Role"></td>
                                            <td class="border px-4 py-2" x-text="user.AccessBoats"></td>
                                            <td class="border px-4 py-2" x-text="user.Permissions"></td>
                                            <td class="border px-4 py-2">
                                                <button @click="editUser(user)"
                                                    class="text-blue-600 hover:underline mr-2">
                                                    <i class='bx bx-edit-alt'></i>
                                                </button>
                                                <button @click="removeUser(user)" class="text-red-600 hover:underline">
                                                    <i class='bx bx-trash'></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <button type="button" @click.prevent="openUserModal()"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center">
                                <i class='bx bx-plus mr-2'></i> Add User
                            </button>
                        </div>

                        <div>
                            <h3 class="font-semibold mb-2">Boats</h3>
                            <table id="boatsTable" class="min-w-full bg-gray-50 rounded mb-4">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2">Boat Name</th>
                                        <th class="px-4 py-2">Max Capacity</th>
                                        <th class="px-4 py-2">Managers</th>
                                        <th class="px-4 py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="boat in boats" :key="boat.ID">
                                        <tr>
                                            <td class="border px-4 py-2" x-text="boat.Name"></td>
                                            <td class="border px-4 py-2" x-text="boat.MaxCapacity"></td>
                                            <td class="border px-4 py-2" x-text="boat.Managers"></td>
                                            <td class="border px-4 py-2">
                                                <button @click="editBoat(boat)"
                                                    class="text-blue-600 hover:underline mr-2">
                                                    <i class='bx bx-edit-alt'></i>
                                                </button>
                                                <button @click="removeBoat(boat)" class="text-red-600 hover:underline">
                                                    <i class='bx bx-trash'></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <button type="button" @click.prevent="openBoatModal()"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center">
                                <i class='bx bx-plus mr-2'></i> Add Boat
                            </button>
                        </div>
                    </div>
                </div>

                <?!= include('Backend/Client/Components/Modals/BookingModal'); ?>
                <?!= include('Backend/Client/Components/Modals/UserModal'); ?>
                <?!= include('Backend/Client/Components/Modals/BoatModal'); ?>

                    <!-- jQuery -->
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
                    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
                    <script src="https://cdn.datatables.net/plug-ins/1.10.12/sorting/datetime-moment.js"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

            </main>

        </div>
        <footer class="w-full bg-white text-right p-4">
            Built by <a target="_blank" href="https://fiverr.com/web_coder_nsd" class="underline">noushadBug</a>.
        </footer>

    </div>

    <!-- Box Icons -->
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

    <script>
        function dashboardApp() {
            return {
                // Data
                bookings: [],
                users: [],
                boats: [],
                drivers: [],
                loading: false,
                user: null,

                // UI State
                showBookingModal: false,
                bookingModalTitle: '',
                bookingForm: {
                    date: '',
                    boat: '',
                    tripType: '',
                    status: '',
                    clients: '',
                    phone: '',
                    adults: 0,
                    children: 0,
                    childAges: '',
                    totalPax: 1,
                    payment: '',
                    paid: '',
                    commission: '',
                    partner: '',
                    driver: '',
                    hotel: '',
                    transfer: '',
                    transferTime: '',
                    comments: ''
                },
                editingBookingId: null,

                // Messages
                messageDate: new Date().toISOString().split('T')[0],
                messageType: 'driver',
                generatedMessage: '',

                // Admin
                showUserModal: false,
                showBoatModal: false,
                userModalTitle: '',
                boatModalTitle: '',
                userForm: {
                    name: '',
                    email: '',
                    password: '',
                    role: 'Staff',
                    accessBoats: ''
                },
                editingUserId: null,
                boatForm: {
                    name: '',
                    colorLabel: 'ðŸ›¥ï¸',
                    colorHex: '#000000',
                    maxCapacity: 12,
                    managers: ''
                },
                editingBoatId: null,

                // Methods
                async loadData() {
                    this.loading = true;

                    try {
                        google.script.run
                            .withSuccessHandler(result => {
                                if (result && result.success) {
                                    this.bookings = result.data || [];
                                    setTimeout(() => {
                                        this.initializeDataTables();
                                        this.loading = false;
                                    }, 100);
                                } else {
                                    let errorMsg = 'Unknown error';
                                    if (result && result.error) {
                                        errorMsg = result.error;
                                    }
                                    this.showToast('Error loading bookings: ' + errorMsg, 'error');
                                    this.loading = false;
                                }
                            })
                            .withFailureHandler(error => {
                                this.showToast('Failed to load bookings: ' + error, 'error');
                                this.loading = false;
                            })
                            .getBookings(this.user);

                        google.script.run
                            .withSuccessHandler(result => {
                                if (result && result.success) {
                                    this.boats = result.data || [];
                                }
                            })
                            .getBoats(this.user);

                        google.script.run
                            .withSuccessHandler(result => {
                                if (result && result.success) {
                                    this.users = result.data || [];
                                }
                            })
                            .getUsers(this.user);

                        google.script.run
                            .withSuccessHandler(result => {
                                if (result && result.success) {
                                    this.drivers = result.data || [];
                                }
                            })
                            .getDrivers();

                    } catch (error) {
                        this.showToast('Error loading data: ' + error, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                initializeDataTables() {
                    // Initialize DataTables after data is loaded
                    if ($.fn.DataTable) {
                        const tables = {
                            'bookingsTable': {
                                config: {
                                    responsive: true,
                                    pageLength: 10,
                                    order: [[0, 'desc']],
                                    columns: [
                                        { data: 'Date', title: 'Date' },
                                        { data: 'Boat', title: 'Boat' },
                                        { data: 'TripType', title: 'Trip Type' },
                                        { data: 'Clients', title: 'Clients' },
                                        { data: 'TotalPAX', title: 'PAX' },
                                        { data: 'Status', title: 'Status' }
                                    ]
                                }
                            },
                            'allBookingsTable': {
                                config: {
                                    responsive: true,
                                    pageLength: 25,
                                    order: [[1, 'desc']],
                                    columns: [
                                        { data: 'Date', title: 'Date' },
                                        { data: 'Boat', title: 'Boat' },
                                        { data: 'TripType', title: 'Trip Type' },
                                        { data: 'Clients', title: 'Clients' },
                                        { data: 'TotalPAX', title: 'PAX' },
                                        { data: 'Status', title: 'Status' },
                                        { data: 'Actions', title: 'Actions' }
                                    ]
                                }
                            },
                            'usersTable': {
                                config: {
                                    responsive: true,
                                    pageLength: 10,
                                    columns: [
                                        { data: 'Name', title: 'Name' },
                                        { data: 'Email', title: 'Email' },
                                        { data: 'Role', title: 'Role' },
                                        { data: 'AccessBoats', title: 'Access Boats' }
                                    ]
                                }
                            },
                            'boatsTable': {
                                config: {
                                    responsive: true,
                                    pageLength: 10,
                                    columns: [
                                        { data: 'Name', title: 'Name' },
                                        { data: 'ColorLabel', title: 'Label' },
                                        { data: 'ColorHex', title: 'Color' },
                                        { data: 'MaxCapacity', title: 'Max Capacity' },
                                        { data: 'Managers', title: 'Managers' }
                                    ]
                                }
                            }
                        };

                        // Initialize or refresh each table if it exists
                        Object.entries(tables).forEach(([tableId, { config }]) => {
                            const table = document.getElementById(tableId);
                            if (table) {
                                if ($.fn.DataTable.isDataTable('#' + tableId)) {
                                    $('#' + tableId).DataTable().destroy();
                                }
                                $('#' + tableId).DataTable({
                                    ...config,
                                    data: this[tableId.replace('Table', 's')] || []
                                });
                            }
                        });
                    }
                },

                // Prepare and display booking modal for a new booking
                openAddBookingModal() {
                    this.bookingModalTitle = 'Add New Booking';
                    this.bookingForm = {
                        date: new Date().toISOString().split('T')[0],
                        boat: 'MAYA',
                        tripType: '',
                        status: 'Confirmed',
                        clients: '',
                        phone: '',
                        adults: 0,
                        children: 0,
                        childAges: '',
                        totalPax: 1,
                        payment: '',
                        paid: 'TBC',
                        commission: '',
                        partner: '',
                        driver: '',
                        hotel: '',
                        transfer: 'No',
                        transferTime: '',
                        comments: ''
                    };
                    this.editingBookingId = null;
                    this.showBookingModal = true;
                },

                editBooking(booking) {
                    this.bookingModalTitle = 'Edit Booking';
                    this.bookingForm = {
                        date: booking.Date,
                        boat: booking.Boat || 'MAYA',
                        tripType: booking.TripType,
                        status: booking.Status || 'Confirmed',
                        clients: booking.Clients,
                        phone: booking.Phone || '',
                        adults: parseInt(booking.Adults) || 0,
                        children: parseInt(booking.Children) || 0,
                        childAges: booking.ChildAges || '',
                        totalPax: parseInt(booking.TotalPAX) || 1,
                        payment: booking.Payment || '',
                        paid: booking.Paid || 'TBC',
                        commission: booking.Commission || '',
                        partner: booking.Partner || '',
                        driver: booking.Driver || '',
                        hotel: booking.Hotel || '',
                        transfer: booking.Transfer || 'No',
                        transferTime: booking.TransferTime || '',
                        comments: booking.Comments || ''
                    };
                    this.editingBookingId = booking.BookingID;
                    this.showBookingModal = true;
                },

                async saveBooking() {
                    this.loading = true;
                    try {
                        if (this.editingBookingId) {
                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.success) {
                                        this.showToast('Booking updated successfully!', 'success');
                                        this.loadData();
                                        this.showBookingModal = false;
                                    } else {
                                        this.showToast('Error updating booking: ' + response.error, 'error');
                                    }
                                    this.loading = false;
                                })
                                .withFailureHandler(error => {
                                    this.showToast('Error updating booking: ' + error, 'error');
                                    this.loading = false;
                                })
                                .updateBooking(this.user, this.editingBookingId, this.bookingForm);
                        } else {
                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.success) {
                                        this.showToast('Booking added successfully!', 'success');
                                        this.loadData();
                                        this.showBookingModal = false;
                                    } else {
                                        this.showToast('Error adding booking: ' + response.error, 'error');
                                    }
                                    this.loading = false;
                                })
                                .withFailureHandler(error => {
                                    this.showToast('Error adding booking: ' + error, 'error');
                                    this.loading = false;
                                })
                                .addBooking(this.user, this.bookingForm);
                        }
                    } catch (error) {
                        this.showToast('Error saving booking: ' + error, 'error');
                        this.loading = false;
                    }
                },

                async deleteBooking(id) {
                    if (!confirm('Are you sure you want to delete this booking?')) return;

                    this.loading = true;
                    try {
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.success) {
                                    this.showToast('Booking deleted successfully!', 'success');
                                    this.loadData();
                                } else {
                                    this.showToast('Error deleting booking: ' + response.error, 'error');
                                }
                                this.loading = false;
                            })
                            .withFailureHandler(error => {
                                this.showToast('Error deleting booking: ' + error, 'error');
                                this.loading = false;
                            })
                            .deleteBooking(this.user, id);
                    } catch (error) {
                        this.showToast('Error deleting booking: ' + error, 'error');
                        this.loading = false;
                    }
                },

                async generateMessage() {
                    this.loading = true;
                    try {
                        // Normalize date to YYYY-MM-DD
                        let date = this.messageDate;
                        if (date instanceof Date) {
                            date = date.toISOString().split('T')[0];
                        }
                        if (typeof date === 'string' && date.includes('/')) {
                            // Convert from MM/DD/YYYY or DD/MM/YYYY to YYYY-MM-DD
                            const parts = date.split('/');
                            if (parts[2].length === 4) {
                                // MM/DD/YYYY
                                date = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                            }
                        }
                        const handler = response => {
                            this.generatedMessage = response && response.message ? response.message : 'No message.';
                            if (response && response.success) {
                                this.showToast('Message generated successfully!', 'success');
                            } else {
                                this.showToast('Error generating message: ' + (response && response.error ? response.error : 'Unknown error'), 'error');
                            }
                            this.loading = false;
                        };
                        const failHandler = error => {
                            this.generatedMessage = 'Failed to generate message.';
                            this.showToast('Failed to generate message: ' + error, 'error');
                            this.loading = false;
                        };
                        if (this.messageType === 'driver') {
                            google.script.run
                                .withSuccessHandler(handler)
                                .withFailureHandler(failHandler)
                                .generateDriverMessage(date);
                        } else {
                            google.script.run
                                .withSuccessHandler(handler)
                                .withFailureHandler(failHandler)
                                .generateStaffMessage(date);
                        }
                    } catch (error) {
                        this.generatedMessage = 'Error generating message.';
                        this.showToast('Error generating message: ' + error, 'error');
                        this.loading = false;
                    }
                },

                copyMessage() {
                    navigator.clipboard.writeText(this.generatedMessage).then(() => {
                        this.showToast('Message copied to clipboard!', 'success');
                    });
                },

                printMessage() {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write('<pre>' + this.generatedMessage + '</pre>');
                    printWindow.document.close();
                    printWindow.print();
                },

                // Computed properties
                get sortedBookings() {
                    return this.bookings.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                },

                getTodayBookings() {
                    const today = new Date().toISOString().split('T')[0];
                    return this.bookings.filter(booking => booking.Date === today);
                },

                getTotalPax() {
                    return this.bookings.reduce((sum, booking) => sum + (parseInt(booking.TotalPAX) || 0), 0);
                },

                // Utility methods
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString();
                },

                getTripColor(tripType) {
                    const colors = {
                        'Private': 'bg-purple-50',
                        'Shared': 'bg-blue-50',
                        'Sunset': 'bg-orange-50',
                        'DayOff': 'bg-red-50',
                        'Day Off': 'bg-red-50'
                    };
                    return colors[tripType] || 'bg-gray-50';
                },

                getTripBadgeClass(tripType) {
                    const classes = {
                        'Private': 'bg-purple-100 text-purple-800',
                        'Shared': 'bg-blue-100 text-blue-800',
                        'Sunset': 'bg-orange-100 text-orange-800',
                        'DayOff': 'bg-red-100 text-red-800',
                        'Day Off': 'bg-red-100 text-red-800'
                    };
                    return classes[tripType] || 'bg-gray-100 text-gray-800';
                },

                getStatusBadgeClass(status) {
                    const classes = {
                        'Confirmed': 'bg-green-100 text-green-800',
                        'Pending': 'bg-yellow-100 text-yellow-800',
                        'Cancelled': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                showToast(message, type = 'info') {
                    if (window.toastr) {
                        toastr[type](message);
                    } else {
                        console.log(`${type.toUpperCase()}: ${message}`);
                    }
                },

                // Navigation methods
                changeView(view) {
                    // Reset all views
                    this.$store.appStore.dashboardView = false;
                    this.$store.appStore.bookingsView = false;
                    this.$store.appStore.messagesView = false;
                    this.$store.appStore.adminView = false;

                    // Set the selected view
                    this.$store.appStore[view] = true;
                },

                logout() {
                    this.user = null;
                    this.$store.appStore.isULoggedIn = false;
                    this.$store.appStore.user = null;
                    this.$store.appStore.dashboardView = true;
                    this.$store.appStore.bookingsView = false;
                    this.$store.appStore.messagesView = false;
                    this.$store.appStore.adminView = false;
                    localStorage.removeItem('bms_user');
                },

                // User management functions
                removeUser(user) {
                    if (!confirm('Are you sure you want to remove this user?')) return;

                    this.loading = true;
                    try {
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.success) {
                                    this.showToast('User removed successfully!', 'success');
                                    this.loadData();
                                } else {
                                    this.showToast('Error removing user: ' + (response.error || 'Unknown error'), 'error');
                                }
                                this.loading = false;
                            })
                            .withFailureHandler(error => {
                                this.showToast('Error removing user: ' + error, 'error');
                                this.loading = false;
                            })
                            .deleteUser(this.user, String(user.ID)); // Convert ID to string
                    } catch (error) {
                        this.showToast('Error removing user: ' + error, 'error');
                        this.loading = false;
                    }
                },

                // Display user modal with empty form for new entries
                openUserModal() {
                    console.log('Opening user modal');
                    this.userModalTitle = 'Add New User';
                    this.userForm = {
                        name: '',
                        email: '',
                        password: '',
                        role: 'Staff',
                        accessBoats: '',
                        permissions: 'view',
                        phone: ''
                    };
                    this.editingUserId = null;
                    this.showUserModal = true;
                    this.$nextTick(() => this.initUserSelects());
                },

                // Populate modal with existing user data for editing
                editUser(user) {
                    this.userModalTitle = 'Edit User';
                    this.userForm = {
                        name: user.Name,
                        email: user.Email,
                        password: '',
                        role: user.Role,
                        accessBoats: user.AccessBoats,
                        permissions: user.Permissions,
                        phone: user.Phone
                    };
                    this.editingUserId = user.ID;
                    this.showUserModal = true;
                    this.$nextTick(() => this.initUserSelects());
                },

                // Initialize select2 dropdowns and sync selections with form state
                initUserSelects() {
                    const access = $('#accessBoatsSelect');
                    access.off('change').select2({ width: '100%', placeholder: 'Select boats' });
                    const boats = this.userForm.accessBoats ? this.userForm.accessBoats.split(',') : [];
                    access.val(boats).trigger('change');
                    access.on('change', () => {
                        const val = access.val();
                        this.userForm.accessBoats = val ? val.join(',') : '';
                    });

                    const perms = $('#permissionsSelect');
                    perms.off('change').select2({ width: '100%', placeholder: 'Select permissions' });
                    const permissions = this.userForm.permissions ? this.userForm.permissions.split(',') : [];
                    perms.val(permissions).trigger('change');
                    perms.on('change', () => {
                        const val = perms.val();
                        this.userForm.permissions = val ? val.join(',') : '';
                    });
                },

                saveUser() {
                    this.loading = true;
                    const accessVal = $('#accessBoatsSelect').val();
                    const permVal = $('#permissionsSelect').val();
                    this.userForm.accessBoats = accessVal ? accessVal.join(',') : '';
                    this.userForm.permissions = permVal ? permVal.join(',') : '';
                    try {
                        if (this.editingUserId) {
                            google.script.run
                                .withSuccessHandler(res => {
                                    if (res.success) {
                                        this.showToast('User updated successfully!', 'success');
                                        this.loadData();
                                        this.showUserModal = false;
                                    } else {
                                        this.showToast('Error updating user: ' + res.error, 'error');
                                    }
                                    this.loading = false;
                                })
                                .withFailureHandler(err => {
                                    this.showToast('Error updating user: ' + err, 'error');
                                    this.loading = false;
                                })
                                .updateUser(this.user, this.editingUserId, this.userForm);
                        } else {
                            google.script.run
                                .withSuccessHandler(res => {
                                    if (res.success) {
                                        this.showToast('User added successfully!', 'success');
                                        this.loadData();
                                        this.showUserModal = false;
                                    } else {
                                        this.showToast('Error adding user: ' + res.error, 'error');
                                    }
                                    this.loading = false;
                                })
                                .withFailureHandler(err => {
                                    this.showToast('Error adding user: ' + err, 'error');
                                    this.loading = false;
                                })
                                .addUser(this.user, this.userForm);
                        }
                    } catch (error) {
                        this.showToast('Error saving user: ' + error, 'error');
                        this.loading = false;
                    }
                },

                // Boat management functions
                // Display boat modal with empty form for new boat entries
                openBoatModal() {
                    console.log('Opening boat modal');
                    this.boatModalTitle = 'Add New Boat';
                    this.boatForm = {
                        name: '',
                        colorLabel: 'ðŸ›¥ï¸',
                        colorHex: '#000000',
                        maxCapacity: 12,
                        managers: ''
                    };
                    this.editingBoatId = null;
                    this.showBoatModal = true;
                },

                editBoat(boat) {
                    this.boatModalTitle = 'Edit Boat';
                    this.boatForm = {
                        name: boat.Name,
                        colorLabel: boat.ColorLabel,
                        colorHex: boat.ColorHex,
                        maxCapacity: parseInt(boat.MaxCapacity) || 12,
                        managers: boat.Managers
                    };
                    this.editingBoatId = boat.ID;
                    this.showBoatModal = true;
                },

                saveBoat() {
                    this.loading = true;
                    try {
                        if (this.editingBoatId) {
                            google.script.run
                                .withSuccessHandler(res => {
                                    if (res.success) {
                                        this.showToast('Boat updated successfully!', 'success');
                                        this.loadData();
                                        this.showBoatModal = false;
                                    } else {
                                        this.showToast('Error updating boat: ' + res.error, 'error');
                                    }
                                    this.loading = false;
                                })
                                .withFailureHandler(err => {
                                    this.showToast('Error updating boat: ' + err, 'error');
                                    this.loading = false;
                                })
                                .updateBoat(this.user, this.editingBoatId, this.boatForm);
                        } else {
                            google.script.run
                                .withSuccessHandler(res => {
                                    if (res.success) {
                                        this.showToast('Boat added successfully!', 'success');
                                        this.loadData();
                                        this.showBoatModal = false;
                                    } else {
                                        this.showToast('Error adding boat: ' + res.error, 'error');
                                    }
                                    this.loading = false;
                                })
                                .withFailureHandler(err => {
                                    this.showToast('Error adding boat: ' + err, 'error');
                                    this.loading = false;
                                })
                                .addBoat(this.user, this.boatForm);
                        }
                    } catch (error) {
                        this.showToast('Error saving boat: ' + error, 'error');
                        this.loading = false;
                    }
                },

                removeBoat(boat) {
                    if (!confirm('Are you sure you want to remove this boat?')) return;

                    this.loading = true;
                    try {
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.success) {
                                    this.showToast('Boat removed successfully!', 'success');
                                    this.loadData();
                                } else {
                                    this.showToast('Error removing boat: ' + response.error, 'error');
                                }
                                this.loading = false;
                            })
                            .withFailureHandler(error => {
                                this.showToast('Error removing boat: ' + error, 'error');
                                this.loading = false;
                            })
                            .deleteBoat(this.user, boat.ID);
                    } catch (error) {
                        this.showToast('Error removing boat: ' + error, 'error');
                        this.loading = false;
                    }
                },

                // Login function
                login() {
                    const email = document.querySelector('input[type=email]').value.trim();
                    const password = document.querySelector('input[type=password]').value;
                    this.loading = true;
                    try {
                        google.script.run
                            .withSuccessHandler(res => {
                                if (res.success) {
                                    this.user = res.user;
                                    this.$store.appStore.isULoggedIn = true;
                                    this.$store.appStore.user = res.user;
                                    this.$store.appStore.dashboardView = true;
                                    this.$store.appStore.bookingsView = false;
                                    this.$store.appStore.messagesView = false;
                                    this.$store.appStore.adminView = false;
                                    // Store in localStorage with 10 day expiry
                                    const session = { user: res.user, ts: Date.now() };
                                    localStorage.setItem('bms_user', JSON.stringify(session));
                                    this.loadData();
                                    this.showToast('Login successful!', 'success');
                                } else {
                                    this.showToast(res.error || 'Login failed', 'error');
                                }
                                this.loading = false;
                            })
                            .withFailureHandler(error => {
                                this.showToast('Login error: ' + error, 'error');
                                this.loading = false;
                            })
                            .loginUser(email, password);
                    } catch (error) {
                        this.showToast('Login error: ' + error, 'error');
                        this.loading = false;
                    }
                },
                checkSession() {
                    const sessionStr = localStorage.getItem('bms_user');
                    if (sessionStr) {
                        const session = JSON.parse(sessionStr);
                        // 10 days expiry
                        if (session.ts && (Date.now() - session.ts) < 10 * 24 * 60 * 60 * 1000) {
                            this.user = session.user;
                            this.$store.appStore.isULoggedIn = true;
                            this.$store.appStore.user = session.user;
                            this.$store.appStore.dashboardView = true;
                            this.loadData();
                            return true;
                        } else {
                            localStorage.removeItem('bms_user');
                            this.showToast('Session expired. Please log in again.', 'error');
                        }
                    }
                    this.$store.appStore.isULoggedIn = false;
                    return false;
                },
                // Permission helpers
                hasPermission(action) {
                    if (!this.user) return false;
                    if (this.user.Role === 'Admin') return true;
                    if (!this.user.Permissions) return false;
                    const perms = this.user.Permissions.split(',').map(p => p.trim().toLowerCase());
                    return perms.includes('all') || perms.includes(action.toLowerCase());
                },
                canViewBoat(boatName) {
                    if (!this.hasPermission('view')) return false;
                    const boat = this.boats.find(b => b.Name === boatName);
                    if (!boat) return false;
                    const allowed = this.user.AccessBoats ? this.user.AccessBoats.split(',').map(id => id.trim()) : [];
                    return allowed.includes(String(boat.ID));
                },
                canEditBooking(booking) {
                    if (!this.hasPermission('edit')) return false;
                    const boat = this.boats.find(b => b.Name === booking.Boat);
                    if (!boat) return false;
                    const allowed = this.user.AccessBoats ? this.user.AccessBoats.split(',').map(id => id.trim()) : [];
                    return allowed.includes(String(boat.ID));
                },
                isAdmin() {
                    return this.hasPermission('all');
                },
                // On Alpine init
                init() {
                    this.checkSession();
                },
            }
        }
    </script>

</body>

</html>